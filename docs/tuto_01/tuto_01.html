
<!DOCTYPE html>


<html lang="fr" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tutoriel 1 --- Prise en main &#8212; Documentation DRV 2025 </title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/color.css?v=8770e769" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=72dce1d2"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../_static/translations.js?v=bf059b8c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tuto_01/tuto_01';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="Laboratoire 2 --- User-space Drivers" href="../lab_02/lab_02.html" />
    <link rel="prev" title="Mise en place de SSH sur la carte" href="../helper/ssh.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="fr"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Passer au contenu principal</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Haut de page</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Alerte de version"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo_drv.png" class="logo__image only-light" alt="Documentation DRV 2025  - Home"/>
    <img src="../_static/logo_drv.png" class="logo__image only-dark pst-js-only" alt="Documentation DRV 2025  - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Recherche" aria-label="Recherche" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Recherche</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../helper/helper.html">Helper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../helper/eval_criterion.html">Consigne de rendu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_00/lab_00.html">Laboratoire 0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_01/lab_01.html">Laboratoire 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../helper/ssh.html">Mise en place SSH</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tuto 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_02/lab_02.html">Laboratoire 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuto_02/tuto_02.html">Tuto 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_03/lab_03.html">Laboratoire 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_04/lab_04.html">Laboratoire 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tuto_03/tuto_03.html">Tuto 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lab_05/lab_05.html">Laboratoire 5</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Téléchargez cette page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/tuto_01/tuto_01.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Télécharger le fichier source"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Imprimer au format PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Mode plein écran"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Thème" data-bs-title="Thème"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Clair"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Sombre"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="Paramètres système"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Recherche" aria-label="Recherche" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Tutoriel 1 --- Prise en main</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contenu </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#drv-adder">DRV-adder</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="tutoriel-1-prise-en-main">
<span id="tutoriel1"></span><h1>Tutoriel 1 --- Prise en main<a class="headerlink" href="#tutoriel-1-prise-en-main" title="Lien vers cette rubrique">#</a></h1>
<p>Cette série de tutoriels a été développé afin de vous accompagner dans la création de drivers Linux.
On commencera par créer un driver pour un périphérique très simple (présenté ci-dessous), et on
évoluera vers des designs plus réalistes.
L'idée est de vous donner une méthodologie et du code &quot;qui marche&quot; (trop souvent le code que vous
trouvez sur Internet est bogué ou mal écrit), afin que vous puissiez être &quot;inspirés&quot; par ces codes.</p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p><strong>Vous êtes invités à les bricoler jusqu'à ce qu'ils se cassent ! (les logiciels, pas les
cartes !)</strong>
Rien n'est plus éducatif que bricoler quelque chose pour l'améliorer ou, tout
simplement, essayer de comprendre comment ça fonctionne ;-)</p>
</div>
<section id="drv-adder">
<h2>DRV-adder<a class="headerlink" href="#drv-adder" title="Lien vers cette rubrique">#</a></h2>
<p>Le périphérique qu'on va vous décrire ne fait vraiment rien d'utile. Par contre, il représente un
bon exemple d'un périphérique mappé en mémoire --- son utilisation ne diffère pas beaucoup d'un
&quot;vrai&quot; dispositif sans avoir toute la complexité liée à un vrai dispositif, d'où son intérêt pour
nous.</p>
<p>Le développeur du périphérique nous a gentiment donné les adresses de registres :</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><div class="line-block">
<div class="line">Adresse</div>
</div>
</th>
<th class="head"><div class="line-block">
<div class="line">Registre</div>
</div>
</th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line">0x0000</div>
</div>
</td>
<td><div class="line-block">
<div class="line">ID device (0xCAFECAFE)</div>
</div>
</td>
<td><p>RO</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">0x0004</div>
</div>
</td>
<td><div class="line-block">
<div class="line">increment</div>
</div>
</td>
<td><p>RW</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">0x0008</div>
</div>
</td>
<td><div class="line-block">
<div class="line">value</div>
</div>
</td>
<td><p>RW</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">0x000C</div>
</div>
</td>
<td><div class="line-block">
<div class="line">initialization</div>
</div>
</td>
<td><p>WO</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">0x0010</div>
</div>
</td>
<td><div class="line-block">
<div class="line">threshold</div>
</div>
</td>
<td><p>RW</p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line">0x0080</div>
</div>
</td>
<td><div class="line-block">
<div class="line">irq mask</div>
</div>
</td>
<td><p>RW</p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line">0x0084</div>
</div>
</td>
<td><div class="line-block">
<div class="line">irq capture</div>
</div>
</td>
<td><p>RW</p></td>
</tr>
</tbody>
</table>
</div>
<p>(RO = Read Only, WO = Write Only, RW = Read-Write).</p>
<p>Il nous a aussi dit qu'il est parti du <em>DE1-SoC Computer System</em> fourni par
Altera.
Ci-dessous une capture d'écran qui montre les connexions dans QSys pour le Altera Computer,
avec tout au fond notre bloc (<strong>reds_custom_0</strong>) :</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/qsys.png"><img alt="../_images/qsys.png" src="../_images/qsys.png" style="width: 22cm;" /></a>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Explorez les connexions de notre bloc et essayez de découvrir pourquoi il a été ainsi câblé.</p>
</div>
<p>Depuis cette image, on peut s'imaginer que le dispositif aura un offset de 0xFF205000 dans la
mémoire (car les &quot;lightweight FPGA slaves&quot; sont mappés à partir de l'adresse 0xFF200000).
Le développeur du reds-adder nous a dit que le numéro d'interruption est 75.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Comment ai-je pu parvenir à cette valeur ? Pourquoi le designer n'a pas choisi 0xFF200000 ?
Ou, encore mieux, 0x00000000 ?</p>
</div>
<p>Pour le vérifier, on peut essayer de lire l'ID du dispositif.</p>
<div class="admonition warning">
<p class="admonition-title">Avertissement</p>
<p>Le développement d'un dispositif demande souvent l'étroite collaboration de personnes
du côté HW et du côté SW de la force.
Avoir un simple registre avec une constante facilement identifiable (non, zéro n'est pas
une bonne valeur...) permet à l'ingénieur SW de vérifier que :</p>
<ul class="simple">
<li><p>le dispositif est sous tension</p></li>
<li><p>le dispositif a une horloge active</p></li>
<li><p>il est en train de parler avec le bon dispositif</p></li>
<li><p>il sait correctement lire depuis le dispositif</p></li>
<li><p>l'endianness est celle qu'il pensait (ou pas) --- au moins, s'il a
été malin lors du choix de la constante, donc peut-être 0xAAAAAAAA
n'est pas la meilleure valeur non plus</p></li>
<li><p>...</p></li>
</ul>
<p>Avoir en plus un registre avec le numéro de version du bitstream
c'est top :)</p>
<p>Votre assistant a bêtement passé des décennies de sa vie en essayant de communiquer avec
des dispositifs en power-down, ou bien avec le dispositif à la mauvaise adresse, ou avec l'
horloge désactivée, ou ...</p>
<p>Vous êtes donc autorisés à frapper votre ingénieur HW jusqu'à ce qu'il accepte d'ajouter
ces registres dans son design !!! ;-)</p>
</div>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/reset.png"><img alt="../_images/reset.png" src="../_images/reset.png" style="width: 22cm;" /></a>
</figure>
<p>Oups..... mais oui, c'est normal ! Il faut d'abord booter une fois la carte pour que l'image du
bitstream soit chargée dans la mémoire (faudrait vraiment faire ce qu'on demande dans le texte... non !?!?).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Est-il vraiment nécessaire ? Pourrait-on le faire depuis U-Boot sans
booter Linux ? (regardez les commandes U-Boot utilisées pour booter le
système avec la commande <code class="code highlight console docutils literal highlight-console"><span class="gp"># </span>printenv</code>)</p>
</div>
<p>Donc reboot, et notre hypothèse semble être confirmée :</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/uboot_01.png"><img alt="../_images/uboot_01.png" src="../_images/uboot_01.png" style="width: 12cm;" /></a>
</figure>
<p>On peut maintenant voir ce qu'il nous a communiqué au sujet du fonctionnement du dispositif :</p>
<ul class="simple">
<li><p><strong>value</strong> et <strong>threshold</strong> sont initialisés à 0, <strong>increment</strong> à 1, les interrupts sont désactivés
(<strong>irq mask</strong> à 0) et (bien sûr) il n'y a pas encore de interrupt capturés (donc <strong>irq capture</strong> est
à 0)</p></li>
<li><p>lorsque <strong>increment</strong> est à 1, une lecture de <strong>value</strong> en augmente la valeur de 1 et la retourne</p></li>
<li><p>si <strong>increment</strong> est à 0 alors les lectures n'affectent pas <strong>value</strong></p></li>
<li><p>écrire 1 dans <strong>initialization</strong> remet la valeur de <strong>value</strong> à 0</p></li>
<li><p>si <strong>irq mask</strong> est à 1, alors dès que <strong>value</strong> dépasse <strong>threshold</strong> un interrupt est levé (c.a.d,
<strong>irq capture</strong> devient 1)</p></li>
<li><p>pour nettoyer un interrupt, il faut écrire 1 dans <strong>irq capture</strong>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Imaginons la situation suivante :</p>
<ul class="simple">
<li><p><strong>value</strong>       = 0x1a</p></li>
<li><p><strong>threshold</strong>   = 0x1c</p></li>
<li><p><strong>increment</strong>   = 0x01</p></li>
<li><p><strong>irq capture</strong> = 0x01</p></li>
</ul>
<p>Qu'est-ce qui se passe avec 4 lectures consécutives ? Détaillez les valeurs de tous les
registres. Ensuite, vérifiez vos réponses sur la carte.</p>
</div>
<p>Dans le prochain tutoriel on verra comment interagir avec ce dispositif depuis Linux, et ensuite on
en développera le driver.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../helper/ssh.html"
       title="page précédente">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">précédent</p>
        <p class="prev-next-title">Mise en place de SSH sur la carte</p>
      </div>
    </a>
    <a class="right-next"
       href="../lab_02/lab_02.html"
       title="page suivante">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">suivant</p>
        <p class="prev-next-title">Laboratoire 2 --- User-space Drivers</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contenu
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#drv-adder">DRV-adder</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
Par REDS institute
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, REDS institute.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>